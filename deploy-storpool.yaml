---
- name: Generating StorPool configuration
  hosts: "{{ cluster_group }}"
  become: true
  become_method: sudo
  roles:
    - generate-storpool-config

- name: Installing StorPool converged node
  hosts: "{{ cluster_group }}_block_server_mgmt"
  become: true
  become_method: sudo
  roles:
    - add-storpool-repo
    - install-sp-python
    - install-storpool-services
    - initialize-drives
    - configure-networking
    - configure-cgroups
  vars:
    converged: true

- name: Installing StorPool client node
  hosts: "{{ cluster_group }}_block"
  become: true
  become_method: sudo
  roles:
    - add-storpool-repo
    - install-sp-python
    - install-storpool-services
    - configure-networking
    - configure-cgroups
  vars:
    converged: false

- name: Starting StorPool services
  hosts: "{{ cluster_group }}"
  become: true
  become_method: sudo
  tasks:
    - name: Enabling StorPool services
      command: /usr/sbin/storpool_ctl enable
    - name: Starting StorPool services
      command: /usr/sbin/storpool_ctl start